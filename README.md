# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:

- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовым кодом

Важные файлы:

- src/pages/index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами
- src/index.ts — точка входа приложения
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск

Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```

## Сборка

```
npm run build
```

или

```
yarn build
```

## Описание проекта

Проект "Веб-ларек" реализует пример типового сервиса для покупки товаров. Пользователь может просматривать каталог товаров, при клике на товар отрывать модальное окно с его полным описанием, также при помощи открывшегося модального окна добавлять товар в корзину, при оформлении заказа пользователь может выбрать способ оплаты. Проект реализован на TypeScript и представляет собой SPA (Single Page Application) с использованием API для получения данных о товарах.

## Данные и типы данных используемые в проекте

Продукт

```typescript
export interface IProduct {
	id:string,
    description: string,
    image: string,
    title: string,
    category: string,
    price: number|null
}
```
Пользователь

```typescript
export interface IUser {
	payment: string;
	address: string;
    email: string;
	phone: string;
}
```

Заказ. Данный интерфейс расширяет интерфейс пользователя

```typescript
export interface IOrder extends IUser {
	items: Pick<IProduct, 'id'>[]; //список id товаров
	total:number; // стоимость заказа
}
```

API для получения продуктов и отправки заказа

```typescript
export interface IShopAPI {
	getProducts: () => Promise<IProduct[]>;
	createOrder: (order: IOrder) => Promise<OrderResult>;
}
```
Интерфейс с дженериком для получения данных от API

```typescript
export type ApiGetResponse<Type> = {
    total: number; // количество товаров 
	items: Type[]; //список товаров
};
```

Интерфейс с дженериком для отправки заказа через API, в таком формате придет ответ от сервера

```typescript
export type ApiOrderResponse<Type> = {
    id: Type;       //id заказа
	total: number; // стоимость заказа
};
```

Интерфейс для данных, которые мы получим после обработки ответа от сервера. Здесь мы точно знаем с каким типом данных для id будем работать, таким образом не приходится тянуть дженерики в интерфейс IShopAPI
```typescript
export interface OrderResult {
	id: string;
	total:number;
}
```

Интерфейс для модели данных продуктов

```typescript
export interface IProductsData {
    products:IProduct[];
    preview:string|null; //сохранение id, выбранной для отображения карточки продукта
}
```

Данные продукта, используемые в модальном окне отображения полной информации о продукте

```typescript
export type TProductInfo = Pick<IProduct, 'description'|'image'|'title'|'category'|'price'>;
```

Данные продукта, используемые в модальном окне корзины

```typescript
export type TBasketProductInfo = Pick<IProduct, 'title'|'price'>;
```

Данные пользователя, используемые в модальном окне для заполнения деталей заказа

```typescript
export type TPaymentDetails = Pick<IUser, 'payment'|'address'>;
```

Данные пользователя, используемые в модальном окне для заполнения контактов пользователя

```typescript
export type TUserContacts = Pick<IUser, 'email'|'phone'>;
```

Данные заказа, используемые в модальном окне успешной оплаты

```typescript
export type TOrderCost= Pick<IOrder, 'total'>
```

Данные заказа, используемые в модальном окне успешной оплаты

```typescript
export type TOrderCost= Pick<IOrder, 'total'>
```

## Архитектура проекта (MVP)
Код приложения разделен на слои согласно парадигме MVP:
- Cлой представления. Отвечает за отображение данных на странице.
- Cлой данных. Отвечает за хранение и изменение данных.
- Презентер. Отвечает за связь слоев представления и данных.

### Базовый код

#### Класс Api
Содержит в себе базовую логику отправки запросов. В конструктор передается базовый адрес сервера и оgциональный объект с заголовками запросов.

Методы:
- `get` - выполняет GET запрос на переданный в параметрах endpoint и возвращает промис с объектом, являющимся ответом сервера.

- `post` - принимает объект с данными, которые будут переданы в JSON-формате в теле запроса, и отправляет эти данные на endpoint, переданный параметром при вызове метода. По умолчанию выполняется 'POST' запрос, но метод запроса может быть переопределен заданием третьего параметра при вызове.

#### Класс EventEmitter

Реализует паттерн «Наблюдатель» и позволяет подписываться на события и уведомлять подписчиков о наступлении события.
Класс имеет методы on , off , emit — для подписки на событие, отписки от события и уведомления подписчиков о наступлении события соответственно.

Основные методы, реализуемые классом, описаны интерфейсом 'IEvents':
- `on` - подписка на событие.
- `emit` - инициализация события.
- `trigger` - возвращает функцию, при вызове которой инициализируется требуемое в параметрах событие.

Дополнительно реализованы методы onAll и offAll — для подписки на все события и сброса всех подписчиков.
Метод trigger, генерирующий заданное событие с заданными аргументами интересен тем, что позволяет передавать сгенерированное событие в качестве обработчика события в другие классы. Эти классы будут генерировать события, не являясь при этом напрямую зависимыми от класса EventEmitter.

### Слой данных

#### Класс ProductsData
Класс отвечает за хранение и логику работы с данными товаров, пришедших с сервера. Имплементирует интерфейс IProductsData.\
Конструктор класса принимает инстант брокера событий\
В полях класса хранятся следующие данные:
- _products: IProduct[] - массив объектов продуктов
- _preview: string | null - id карточки, выбранной для просмотра в модальной окне
- events: IEvents - экземпляр класса `EventEmitter` для инициации событий при изменении данных.

Методы:
- getProduct(productId: string): IProduct - возвращает карточку товара по ее id
- а также сеттеры и геттеры для сохранения и получения данных из полей класса

#### Класс UserData
Класс отвечает за хранение и логику работы с данными текущего пользователя. Имплементирует интерфейс IUser.\
Конструктор класса принимает инстант брокера событий\
В полях класса хранятся следующие данные:
- _payment: string - Метод оплаты
- _address: string - Адрес доставки
- _email: string - Адрес электронной почты пользователя
- _phone: string - Номер телефона пользователя
- events: IEvents - экземпляр класса `EventEmitter` для инициации событий при изменении данных.
Методы:
- checkValidation(data: Record<keyof IUser, string>): boolean - проверяет объект с данными пользователя на валидность
- а также сеттеры и геттеры для сохранения и получения данных из полей класса

### Классы представления
Все классы представления отвечают за отображение внутри контейнера (DOM-элемент) передаваемых в них данных.

#### Базовый Класс Component
Класс является дженериком и родителем всех компонентов слоя представления. В дженерик принимает тип объекта, в котором данные будут передаваться в метод render для отображения данных в компоненте. В конструктор принимает элемент разметки, являющийся основным родительским контейнером компонента. Содержит метод render, отвечающий за сохранение полученных в параметре данных в полях компонентов через их сеттеры, возвращает обновленный контейнер компонента.

#### Класс Modal
Реализует модальное окно. Так же предоставляет методы `open` и `close` для управления отображением модального окна. Устанавливает слушатели на клик в оверлей и кнопку-крестик для закрытия попапа. Данный класс отображает внутри себя любую разметку, которая передается в качестве контента в метод render. Такие классы, как Preview, Basket, Form, Success  генерируют свой контент для отображения в модальном окне.
- constructor(selector: string, events: IEvents) Конструктор принимает селектор, по которому в разметке страницы будет идентифицировано модальное окно и экземпляр класса `EventEmitter` для возможности инициации событий.

Поля класса
- modal: HTMLElement - элемент модального окна
- events: IEvents - брокер событий


#### Класс Preview
Наследует класс Product. Предназначен для генерации контента модального окна, содержащего полную информацию о товаре. 

#### Класс Basket
Наследует класс Product. Предназначен для генерации контента модального окна, содержащего краткую информацию о товаре, находящемся в корзине. 

#### Класс Form
Наследует класс Product. Предназначен для генерации контента модального окна, содержащего краткую информацию о товаре, находящемся в корзине. 

#### Класс Success
Наследует класс Product. Предназначен для генерации контента модального окна, содержащего краткую информацию о товаре, находящемся в корзине. 

#### Класс Preview
Наследует класс Product. Предназначен для генерации контента модального окна, содержащего полную информацию о товаре. 

#### Класс ModalWithConfirm
Расширяет класс Modal. Предназначен для реализации модального окна подтверждения. При открытии модального окна сохраняет полученный в параметрах обработчик, который передается для выполнения при сабмите формы.\
Поля класса:
- submitButton: HTMLButtonElement - Кнопка подтверждения
- _form: HTMLFormElement - элемент формы
- formName: string - значение атрибута name формы
- handleSubmit: Function - функция, на выполнение которой запрашивается подтверждение

Методы:
- setValid(isValid: boolean): void - изменяет активность кнопки подтверждения
- open(handleSubmit: Function): void - расширение родительского метода, принимает обработчик, который передается при инициации события подтверждения.
- get form: HTMLElement - геттер для получения элемента формы

#### Класс ModalWithForm
Расширяет класс Modal. Предназначен для реализации модального окна с формой содержащей поля ввода. При сабмите инициирует событие передавая в него объект с данными из полей ввода формы. При изменении данных в полях ввода инициирует событие изменения данных. Предоставляет методы для отображения ошибок и управления активностью кнопки сохранения.\
Поля класса:
- submitButton: HTMLButtonElement - Кнопка подтверждения
- _form: HTMLFormElement - элемент формы
- formName: string - значение атрибута name формы
- inputs: NodeListOf<HTMLInputElement> - коллекция всех полей ввода формы
- errors: Record<string, HTMLElement> - объект хранящий все элементы для вывода ошибок под полями формы с привязкой к атрибуту name инпутов

Методы:
- setValid(isValid: boolean): void - изменяет активность кнопки подтверждения
- getInputValues(): Record<string, string> - возвращает объект с данными из полей формы, где ключ - name инпута, значение - данные введенные пользователем
- setInputValues(data: Record<string, string>): void - принимает объект с данными для заполнения полей формы
- setError(data: { field: string, value: string, validInformation: string }): void - принимает объект с данными для отображения или сокрытия текстов ошибок под полями ввода
- showInputError (field: string, errorMessage: string): void - отображает полученный текст ошибки под указанным полем ввода
- hideInputError (field: string): void - очищает текст ошибки под указанным полем ввода
- close (): void - расширяет родительский метод дополнительно при закрытии очищая поля формы и деактивируя кнопку сохранения
- get form: HTMLElement - геттер для получения элемента формы

#### Класс ModalWithImage
Расширяет класс Modal. Предназначен для реализации модального окна с изображением в большом размере. При открытии модального окна получает данные изображения, которое нужно показать.\
Поля класса:
- imageElement: HTMLImageElement - элемент разметки с изображением
- imageCaption: HTMLElement - элемент разметки для вывода названия изображения

Методы:
- open(data: { name: string, link: string }): void - расширение родительского метода, принимает данные изображения, которые используются для заполнения атрибутов элементов модального окна.
- close(): void - расширяет родительский метод, выполняя дополнительно очистку атрибутов модального окна.


#### Класс Product
Расширяет класс `Component`.Отвечает за отображение карточки товара, задавая в ней данные категорию, название, изображение и цену товара. Класс используется для отображения карточек товаров на странице сайта. В конструктор класса передается DOM элемент темплейта, что позволяет при необходимости формировать карточки разных вариантов верстки. В классе устанавливается слушатель события 'click' на карточку, в результате срабатывания которого происходит открытие модального окна с подробной информацией о товаре.\
В качестве колбэка в слушатель передается ссылка на метод `onClick(events)`, который выносится отдельным методом класса, делается это для того, чтобы потом была возможность удалить данный слушатель у потомков класса. Для удаления слушателя события предусмотрен метод `removeClickListener`.\
Поля класса содержат элементы разметки элементов карточки товара. Конструктор, кроме темплейта принимает экземпляр `EventEmitter` для инициации событий.\
Метод `onClick` идет c двойным вызовом, для создания замыкания на объекте `events`.
Когда вызывается onClick, передается объект events, и onClick возвращает анонимную функцию, которая в свою очередь вызывает метод emit на объекте events. Так как возвращаемая методом функция является анонимной, то для того, чтобы иметь в дальнейшем возможность удалить слушатель события 'click', мы передаем в него не саму функцию `onClick(events)`, а переменную clickHandler, содержащую результат её вызова.\
Данный класс использует render(ProductData: Partial<IProduct>): HTMLElement родительского класса `Component`, с его помощью происходит заполнение атрибутов элементов карточки данными. Метод возвращает разметку карточки с установленным слушателем события 'click'. Слушатель устанавливается на всю карточку, событие генерируется через экземпляр брокера событий. Кроме того, используются сеттеры и геттеры для сохранения и получения данных из полей класса.

#### Класс ProductsContainer
Отвечает за отображение блока с карточками товаров на главной странице. Предоставляет сеттер `catalog` для полного обновления содержимого. В конструктор принимает контейнер, в котором размещаются карточки.

### Слой коммуникации

#### Класс ShopApi
Принимает в конструктор экземпляр класса Api и предоставляет методы реализующие взаимодействие с бэкендом сервиса.

## Взаимодействие компонентов
Код, описывающий взаимодействие представления и данных между собой находится в файле `index.ts`, выполняющем роль презентера.\
Взаимодействие осуществляется за счет событий, генерируемых с помощью брокера событий и обработчиков этих событий, описанных в `index.ts`\
В `index.ts` сначала создаются экземпляры всех необходимых классов, а затем настраивается обработка событий.

Пример работы, используемого событийно-ориентированного подхода:
1. Пользователь  нажал на карточку товара
2. Класс отображения Product реагирует на действие пользователя и генерирует событие 'product:selected'.
3. Презентер обрабатывает данное событие и вызывает сеттер preview класса модели данных ProductsData 
4. В модели данных в свойстве preview сохраняется id карточки, на которую был совершен клик пользователя и генерируется событие 'preview:changed'
4. Презентер обрабатывает данное событие и вызывает рендер класса отображения Modal, в который в качестве контента передается результат рендера класса отображения Preview. Класс Preview при этом в качестве аргументов для рендера принимает описание выбранного товара, переданное от модели данных ProductsData.
5. Открывается модальное окно с информацией, соответствующей выбранному товару. За открытие модального окна отвечает вызов метода open внутри рендера класса Modal

*Список всех событий, которые могут генерироваться в системе:*\
*События изменения данных (генерируются классами моделями данных)*
- `products:changed` - изменение массива карточек товаров
- `product:selected` - изменение открываемой в модальном окне картинки карточки
- `preview:changed` - изменение id, выбранной карточки в модели данных
- `basket:changed` - изменение содержимого корзины, срабатывает при удалении карточки из корзины
- `formErrors:changed` - изменение объекта, содержащего ошибки валидации формы
- `order:ready` - успешная валидация обеих форм заказа


*События, возникающие при взаимодействии пользователя с интерфейсом (генерируются классами, отвечающими за представление)*
- `userEdit:open` - открытие модального окна с формой редактирования данных пользователя
- `newCard:open` - открытие модального окна создания новой карточки
- `avatar:open` - открытие модального окна с формой редактирования аватара пользователя
- `card:select` - выбор карточки для отображения в модальном окне
- `card:delete` - выбор карточки для удаления
- `card:like` - изменение состояния лайка на карточке
- `edit-profile:input` - изменение данных в форме с данными пользователя
- `edit-avatar:input` - изменение данных в форме с аватаром пользователя
- `new-place:input` - изменение данных в форме создания новой карточки
- `edit-profile:submit` - сохранение данных пользователя в модальном окне
- `edit-avatar:submit` - сохранение аватара пользователя в модальном окне
- `new-place:submit` - событие, генерируемое при создании новой карточки в форме
- `remove-card:submit` - событие, генерируемое при нажатии "Да" в форме подтверждения
- `edit-profile:validation` - событие, сообщающее о необходимости валидации формы профиля
- `edit-avatar:validation` - событие, сообщающее о необходимости валидации формы аватара пользователя
- `new-place:validation` - событие, сообщающее о необходимости валидации формы создания новой карточки



































